#!/bin/bash
export PATH=$PATH:~/.local/bin:/usr/local/bin:/opt/homebrew/bin
[ "$ZELLIJ" == "" ] || exit 0

# Zellij layouts directory
LAYOUTS_DIR="$HOME/.config/zellij/layouts"

# Get list of available layouts
get_layouts() {
    if [ -d "$LAYOUTS_DIR" ]; then
        find "$LAYOUTS_DIR" -name "*.kdl" -exec basename {} .kdl \; | sort
    fi
}

# Get list of sessions
get_sessions() {
    zellij list-sessions 2>/dev/null | sed -E 's/\x1b\[[0-9;]*m//g' | awk '{print $1}' | grep -v '^$' | sed 's/[[:space:]]*$//' || true
}

# Build options array
options=("NEW SESSION" "Zsh")

# Get existing sessions
sessions=$(get_sessions)

# Add existing sessions
if [ -n "$sessions" ]; then
    while IFS= read -r session; do
        options+=("$session")
    done <<EOF
$sessions
EOF
fi

# Add available layouts (but only if not already a session)
layouts=$(get_layouts)
if [ -n "$layouts" ]; then
    while IFS= read -r layout; do
        # Check if there's already a session with this layout name
        if ! echo "$sessions" | grep -q "^${layout}$"; then
            options+=("layout:$layout")
        fi
    done <<EOF
$layouts
EOF
fi

# Display menu
COLUMNS=1
PS3="Please choose your session: "
echo "Available sessions and layouts"
echo "------------------------------"
echo " "
select opt in "${options[@]}"
do
    case $opt in
        "NEW SESSION")
            read -p "Enter new session name: " SESSION_NAME
            printf "\033]0;%s\007" "$SESSION_NAME"
            exec zellij attach -c "$SESSION_NAME"
            break
            ;;
        "Zsh")
            exec zsh --login
            break
            ;;
        layout:*)
            # Extract layout name and use it as session name
            LAYOUT_NAME="${opt#layout:}"
            printf "\033]0;%s\007" "$LAYOUT_NAME"
            exec zellij --session "$LAYOUT_NAME" --new-session-with-layout "$LAYOUTS_DIR/$LAYOUT_NAME.kdl"
            break
            ;;
        "")
            echo "Invalid option"
            ;;
        *)
            # Attach to existing session
            printf "\033]0;%s\007" "$opt"
            exec zellij attach "$opt"
            break
            ;;
    esac
done
